# SQL과 옵티마이저

---

## 옵티마이저와 우리의 역할

-   **옵티마이저**: 사용자가 작성한 SQL을 가장 효율적으로 실행할 수 있는 실행 계획을 찾아주는 데이터베이스의 핵심 엔진.
-   **우리의 역할**:
    - 좋은 인덱스 설계
    - 최신 통계정보를 유지

---

## 옵티마이저의 형태

옵티마이저는 크게 규칙기준과 비용기준 두 가지 형태로 나뉨.

### 규칙기준 옵티마이저

미리 정해진 규칙의 우선순위에 따라 실행 계획을 생성하는 방식. 데이터의 분포나 특성은 고려하지 않고 오직 정해진 규칙만 따르는 것이 특징

#### 규칙기준 옵티마이저의 장단점

-   **장점**: 규칙이 정해져 있어 실행 계획의 예측이 매우 쉬움.
-   **단점**: 데이터의 특성을 무시하므로 비효율적인 실행 계획을 생성할 가능성이 높음. 현재는 거의 사용되지 않는 구식 기술임.

### 비용기준 옵티마이저

테이블의 통계정보(데이터양, 데이터 종류, 분포도 등)를 바탕으로 각 실행 방법의 비용을 계산하고, 가장 비용이 낮을 것으로 예상되는 실행 계획을 선택하는 방식.

#### 비용기준 옵티마이저의 장단점

-   **장점**: 데이터 특성을 반영하므로 규칙기준보다 훨씬 지능적이고 효율적인 실행 계획을 생성함.
-   **단점**: **통계정보의 정확도**에 따라 성능이 크게 좌우됨. 통계가 오래되거나 부정확하면 오히려 비효율적인 계획을 세울 수 있음.

#### 옵티마이저의 발전 방향

최신 옵티마이저는 단순히 통계에만 의존하지 않고, 쿼리 실행 중 정보를 수집해 계획을 동적으로 수정

#### 통계정보 관리를 위한 제언

비용기준 옵티마이저의 핵심은 **최신 통계정보**임. 대량의 데이터 변경 작업이 발생한 후에는 반드시 통계정보를 다시 수집하여 옵티마이저에게 최신 데이터를 알려줌

---

## 옵티마이저 목표의 선택

옵티마이저가 어떤 목표를 우선으로 실행 계획을 수립할지 설정할 수 있음.

### 옵티마이저 모드의 종류

-   **ALL_ROWS**: 
    - 전체 결과를 반환하는 데까지 걸리는 **총 시간이 가장 짧도록** 최적화. 
    - 배치 작업 등에 적합
-   **FIRST_ROWS**: 
    - **첫 n개의 결과를 가장 빨리** 화면에 보여주는 것을 목표로 최적화. 

### 옵티마이저 모드와 관련된 파라미터 지정

데이터베이스 전체 또는 특정 세션의 옵티마이저 모드를 파라미터로 설정하거나, SQL 쿼리 내에 **힌트**를 사용하여 특정 쿼리에 대해서만 옵티마이저의 동작을 변경할 수 있음.

---

## 실행계획의 고정화

특정 SQL에 대해 최적의 실행 계획을 찾았을 때, 데이터베이스 환경이나 통계정보가 변하더라도 **계속 동일한 실행 계획을 사용하도록** 강제하는 기능. 플랜 안정성을 확보하는 것이 목적.

### 아웃라인의 생성과 조정

**아웃라인(Outline)**은 특정 SQL의 실행 계획을 저장해두는 기능. 옵티마이저는 해당 SQL이 실행될 때 저장된 계획을 참조하여 그대로 실행함.

### 아웃라인 관찰

저장된 아웃라인을 조회하고 관리하여 시스템의 성능을 안정적으로 유지할 수 있음.

### 옵티마이저 업그레이드 시의 적용

데이터베이스 버전을 업그레이드하면 옵티마이저의 동작 방식이 바뀔 수 있음. 이때 아웃라인을 사용하면 업그레이드 전후에도 기존의 검증된 실행 계획을 그대로 사용하게 하여 성능 저하를 방지할 수 있음.

---

## 옵티마이저의 한계

-   통계정보가 부정확하거나 복잡한 SQL의 의도를 잘못 파악하면 최악의 실행 계획을 선택할 수 있음.
-   계산된 비용을 바탕으로 한 **'예측'**, not 실제 실행 결과를 아는 것
